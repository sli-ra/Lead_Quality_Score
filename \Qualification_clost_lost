-- What's causing the most drop out from Qualification to Close Lost

--SELECT *
--FROM [Integrate].[vw_VroomSalesforceOpportunityFieldHistory]
--WHERE VALUE = 'Closed Lost' AND PREVIOUSVALUE = 'Qualification'
--ORDER BY  ENTEREDDATE 

-- What's the distribution of previous stage before closed lost?
DECLARE @ID AS VARCHAR(100)
SET @ID = '0062G00000d5JK6QAM' --'0062G00000d5adNQAQ' --'0062G00000kz14QQAQ' --'0062G00000jbyI0QAI' --'0062G00000lBKoKQAW'--'0062G00000d5a06QAA' --
--0062G00000k4D6IQAU (won)
--0062G00000d5CtlQAE (won)
--0062G00000iEKW4QAO (lost)
--0062G00000d5txTQAQ (2yrs ago changed from apprasial to lost. Vroom recently changed it back to appraisal
--0062G00000d5G0GQAU 2018 Jeep Wrangler. Close-lost 2 yrs ago but revived with 2019 Toyota Tacoma.


--SELECT SUB_STAGE__C, COUNT(SUB_STAGE__C) 
--FROM(
--	SELECT ID, STAGENAME, SUB_STAGE__C, SYSTEMMODSTAMP
--		  ,LEAD(STAGENAME,1) OVER(PARTITION BY ID ORDER BY SYSTEMMODSTAMP) AS STAGENAME_LEAD1
--	FROM [Integrate].[vw_VroomSalesforceOpportunity_DS]
--	--WHERE ID = @ID

--	--ORDER BY SYSTEMMODSTAMP 
--	) AS TEMPTABLE1
--WHERE STAGENAME_LEAD1 = 'Closed Lost' AND STAGENAME <> 'Closed Lost'
--GROUP BY SUB_STAGE__C
--ORDER BY SUB_STAGE__C


--SELECT STAGENAME,  COUNT(STAGENAME), SUB_STAGE__C, COUNT(SUB_STAGE__C)
--FROM(
--	SELECT ID, STAGENAME, SUB_STAGE__C, SYSTEMMODSTAMP
--		  ,LEAD(STAGENAME,1) OVER(PARTITION BY ID ORDER BY SYSTEMMODSTAMP) AS STAGENAME_LEAD1
--	FROM [Integrate].[vw_VroomSalesforceOpportunity_DS]
--	--WHERE ID = @ID
--	--ORDER BY SYSTEMMODSTAMP 
--	) AS TEMPTABLE1
--WHERE STAGENAME_LEAD1 = 'Closed Lost' AND STAGENAME <> 'Closed Lost'
--GROUP BY STAGENAME, SUB_STAGE__C
--ORDER BY STAGENAME, SUB_STAGE__C

-- STAGENAME LEVEL record right before closed lost
--SELECT STAGENAME,  COUNT(STAGENAME)
--FROM(
--	SELECT ID, STAGENAME, SUB_STAGE__C, SYSTEMMODSTAMP
--		  ,LEAD(STAGENAME,1) OVER(PARTITION BY ID ORDER BY SYSTEMMODSTAMP) AS STAGENAME_LEAD1
--	FROM [Integrate].[vw_VroomSalesforceOpportunity_DS]
--	--WHERE ID = @ID
--	--ORDER BY SYSTEMMODSTAMP 
--	) AS TEMPTABLE1
--WHERE STAGENAME_LEAD1 = 'Closed Lost' AND STAGENAME <> 'Closed Lost'
--GROUP BY STAGENAME
--ORDER BY STAGENAME

-- STAGENAME LEVEL record for closed lost
--SELECT STAGENAME, COUNT(STAGENAME)
--FROM(
--	SELECT ID, STAGENAME, SUB_STAGE__C, SYSTEMMODSTAMP
--		  ,LAG(STAGENAME,1) OVER(PARTITION BY ID ORDER BY SYSTEMMODSTAMP) AS STAGENAME_LAG1
--	FROM [Integrate].[vw_VroomSalesforceOpportunity_DS]
--	--WHERE ID = @ID
--	--ORDER BY SYSTEMMODSTAMP 
--	) AS TEMPTABLE1
--WHERE STAGENAME_LAG1 <> 'Closed Lost' AND STAGENAME = 'Closed Lost'
--GROUP BY STAGENAME

-- What's causing the closed lost in qualification -> attempting contact
SELECT STAGENAME_LAG1, COUNT(STAGENAME_LAG1), SUB_STAGE__C, COUNT(SUB_STAGE__C)
FROM(
	SELECT ID, STAGENAME, SUB_STAGE__C, SYSTEMMODSTAMP
			,LAG(STAGENAME,1) OVER(PARTITION BY ID ORDER BY SYSTEMMODSTAMP) AS STAGENAME_LAG1
	FROM [Integrate].[vw_VroomSalesforceOpportunity_DS]
	--WHERE ID = @ID
	) AS TEMPTABLE1
	WHERE STAGENAME = 'Closed Lost' AND STAGENAME_LAG1 <> 'Closed Lost'
GROUP BY STAGENAME_LAG1, SUB_STAGE__C
ORDER BY COUNT(STAGENAME_LAG1) DESC, COUNT(SUB_STAGE__C) DESC
