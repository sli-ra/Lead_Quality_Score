-- Check single ID
--SELECT ID
--		,STAGENAME
--		,SYSTEMMODSTAMP
--		,RNK
--FROM(
--	SELECT ID
--		,STAGENAME
--		,SYSTEMMODSTAMP
--		,CASE 
--			WHEN STAGENAME <> ISNULL(LAG(STAGENAME,1) OVER(PARTITION BY ID ORDER BY SYSTEMMODSTAMP),'placeholder') THEN 1 ELSE 0 
--		 END AS RNK
--		--ROW_NUMBER() OVER (PARTITION BY ID, STAGENAME ORDER BY SYSTEMMODSTAMP) AS RNK
--	FROM [Integrate].[vw_VroomSalesforceOpportunity_DS]
--	WHERE ID = '0062G00000d5JK6QAM'
--	) AS TEMP
--WHERE TEMP.RNK = 1
--ORDER BY SYSTEMMODSTAMP

-- Check multiple IDs
--SELECT  ID
--		,STAGENAME
--		,SYSTEMMODSTAMP
--FROM(
--	SELECT ID


--		,STAGENAME
--		,SYSTEMMODSTAMP
--		,CASE WHEN STAGENAME <> ISNULL(LAG(STAGENAME, 1) OVER (PARTITION BY ID  ORDER BY SYSTEMMODSTAMP),0) THEN 1 ELSE 0 END AS RNK
--	FROM [Integrate].[vw_VroomSalesforceOpportunity_DS]
--	WHERE ID IN ('0062G00000iEKW4QAO', '0062G00000k4D6IQAU','0062G00000d5aqbQAA')
--	) AS TEMP


--WHERE TEMP.RNK = 1
--ORDER BY ID, SYSTEMMODSTAMP


-- Check whole dataset for ID with more than 1 different stage name. 
-- Stage can return to previous value, so Row_number will wrongly combine same stage names from different period together. Use Lag
WITH TEMPTABLE AS (
	SELECT   ID
			,STAGENAME
			,ISNULL(LEAD(STAGENAME,1) OVER(PARTITION BY ID ORDER BY SYSTEMMODSTAMP),'') AS STAGENAME_LEAD
			,CONCAT(STAGENAME, '_', ISNULL(LEAD(STAGENAME,1) OVER(PARTITION BY ID ORDER BY SYSTEMMODSTAMP),'') ) AS STAGE_CHANGE
			,DATEDIFF(DAY, SYSTEMMODSTAMP,  ISNULL(LEAD(SYSTEMMODSTAMP,1) OVER(PARTITION BY ID ORDER BY SYSTEMMODSTAMP),GETDATE())) AS TURNTIME
	FROM(
		SELECT ID
			,STAGENAME
			,SYSTEMMODSTAMP
			,CASE WHEN STAGENAME <> ISNULL(LAG(STAGENAME,1) OVER(PARTITION BY ID ORDER BY SYSTEMMODSTAMP),'placeholder') THEN 1 ELSE 0 END AS RNK
			--ROW_NUMBER() OVER (PARTITION BY ID, STAGENAME ORDER BY SYSTEMMODSTAMP) AS RNK --Create row number for each ID, each stage
		FROM [Integrate].[vw_VroomSalesforceOpportunity_DS]
		--WHERE ID IN ('0062G00000iEKW4QAO', '0062G00000k4D6IQAU','0062G00000d5aqbQAA','0062G00000d5JK6QAM')
		) AS TEMP
	WHERE TEMP.RNK = 1 --Pick the first stage change for each ID to identify the funnel
	AND ID IN(
		SELECT ID
		FROM( 
			SELECT  DISTINCT ID
					,STAGENAME
			FROM [Integrate].[vw_VroomSalesforceOpportunity_DS]
			--WHERE ID IN ('0062G00000iEKW4QAO', '0062G00000k4D6IQAU','0062G00000d5aqbQAA','0062G00000d5JK6QAM')
			) AS TEMP2
		GROUP BY ID
		HAVING COUNT(ID) > 0 --Pick ID that has more than 1 distinct stagename, change to 0 for all opportunities
		)
	--ORDER BY ID, SYSTEMMODSTAMP
)
SELECT TEMPTABLE.STAGE_CHANGE
		,COUNT(TEMPTABLE.STAGE_CHANGE)
FROM TEMPTABLE
GROUP BY TEMPTABLE.STAGE_CHANGE

